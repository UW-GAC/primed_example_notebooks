---
title: "CRC summary statistics"
output: html_notebook
---

# Identify relevant workspaces

This notebook is intended to illustrate combining data from multiple PRIMED 
workspaces for an analysis. We will take the example of a researcher studying
colorectal cancer who wants to use summary statistics from two studies: the
UKBB and published results from a GWAS. Both studies are available in PRIMED
open access workspaces.

- https://anvil.terra.bio/#workspaces/primed-data-cc-open/PRIMED_PAN_UKBB_GSR_CANCER
- https://anvil.terra.bio/#workspaces/primed-data-primed-cancer-open/PRIMED_CRC_PMID36539618

To fetch data from a workspace, we need two pieces of information: the
workspace name and the namespace, also known as the billing project. The URL for
every AnVIL workspace takes the form 
`<https://anvil.terra.bio/#workspaces/namespace/workspace_name>`.

```{r}
ukbb_workspace <- "PRIMED_PAN_UKBB_GSR_CANCER"
ukbb_namespace <- "primed-data-cc-open"
crc_workspace <- "PRIMED_CRC_PMID36539618"
crc_namespace <- "primed-data-primed-cancer-open"
```

# Retrieve data from UKBB workspace

We start with the UKBB Cancer workspace. Using the AnVIL package, we can read in the
`analysis` table to identify relevant analyses for our project.

```{r}
library(AnVIL)
library(dplyr)

ukbb_analysis <- avtable("analysis", 
                    name = ukbb_workspace,
                    namespace = ukbb_namespace)

count(ukbb_analysis, trait)
```

There are four analyses of colorectal cancer, in different populations.

```{r}
ukbb_crc <- ukbb_analysis %>%
  filter(trait == "Colorectal cancer")

count(ukbb_crc, population_descriptor, population_labels)
```

The `gsr_file` table contains bucket paths to the data for these analyses. We
use the `analysis_id` to identify the files we want.

```{r}
ukbb_gsr_file <- avtable("gsr_file", 
                    name = ukbb_workspace,
                    namespace = ukbb_namespace) %>%
  filter(analysis_id %in% ukbb_crc$analysis_id)

count(ukbb_gsr_file, analysis_id)
```

Each analysis has 23 files, one file per chromosome. We copy the files to our
current cloud environment.

```{r}
dir.create("UKBB_CRC")
gsutil_cp(ukbb_gsr_file$file_path, "UKBB_CRC")
```


# Retrieve data from GWAS workspace

The CRC GWAS workspace contains only a single analysis.

```{r}
crc_analysis <- avtable("analysis", 
                    name = crc_workspace,
                    namespace = crc_namespace)

select(crc_analysis, trait, population_descriptor, population_labels)
```

The `gsr_file` table contains bucket paths to the data for this analysis.

```{r}
crc_gsr_file <- avtable("gsr_file", 
                    name = crc_workspace,
                    namespace = crc_namespace)
```

This analysis has only one associated file, with the results for all chromosomes.

```{r}
dir.create("GWAS_CRC")
gsutil_cp(crc_gsr_file$file_path, "GWAS_CRC")
```


# Writing data tables to the workspace

To more easily keep track of the data we're working with, we can create 
`analysis` and `gsr_file` tables in this workspace. Since all data is in the
PRIMED data model, it is straightforward to concatenate tables. The AnVIL 
package has a function to import data tables to a workspace. The `entity`
argument should contain the primary key for the table.

```{r}
bind_rows(crc_analysis, ukbb_analysis) %>%
  avtable_import(entity = "analysis_id")
bind_rows(crc_gsr_file, ukbb_gsr_file) %>%
  avtable_import(entity = "gsr_file_id")
```

